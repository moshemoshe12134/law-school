<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1L Term Companion - Dashboard V2.1</title>
    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            /* Primary - Deep Legal Blues */
            --primary: #1e3a5f;
            --primary-light: #2d5a8b;
            --primary-dark: #0f1c2e;
            
            /* Accent - Gold/Amber */
            --accent: #d4a853;
            --accent-light: #e6c279;
            
            /* Success/Status */
            --success: #2d6a4f;
            --danger: #b91c1c; /* Triage/Panic Mode */
            
            /* Neutrals */
            --bg-primary: #fafafa;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --border: #e0e0e0;

            /* Spacing & UI */
            --radius: 12px;
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
            --shadow-hover: 0 8px 24px rgba(0,0,0,0.1);
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-mono: "SF Mono", "Monaco", "Inconsolata", "Fira Mono", monospace;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: var(--font-main);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            height: 100vh;
        }

        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        .text-sm { font-size: 0.875rem; }
        .font-bold { font-weight: 600; }
        .text-accent { color: var(--accent); }
        .text-primary { color: var(--primary); }
        .text-secondary { color: var(--text-secondary); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .animate-slide-in { animation: slideInRight 0.3s ease-out forwards; }

        /* --- COMPONENTS --- */
        .btn {
            padding: 12px 24px;
            border-radius: var(--radius);
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 1rem;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-light); transform: translateY(-1px); }
        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-primary); }
        .btn-secondary:hover { border-color: var(--primary); color: var(--primary); }
        .btn-accent { background: var(--accent); color: var(--primary-dark); }
        .btn-accent:hover { background: var(--accent-light); transform: translateY(-1px); }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0,0,0,0.03);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); }

        .input-group { margin-bottom: 1.5rem; text-align: left; }
        .input-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary); }
        input[type="text"], input[type="number"], input[type="range"] {
            width: 100%; padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border 0.2s;
        }
        input[type="text"]:focus, input[type="number"]:focus { outline: none; border-color: var(--primary); }

        /* --- VIEWS --- */
        #view-onboarding {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #eef2f6 100%);
        }
        .step-container { max-width: 500px; width: 90%; }
        
        /* Dashboard Layout */
        #view-dashboard { max-width: 1200px; margin: 0 auto; padding: 20px; padding-bottom: 80px; min-height: 100vh; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        .week-nav { display: flex; align-items: center; gap: 16px; }
        .week-display { display: flex; align-items: center; gap: 12px; }
        .chevron-btn { background: none; border: none; color: var(--primary); font-size: 1.5rem; cursor: pointer; padding: 4px 8px; border-radius: 6px; transition: background 0.2s; }
        .chevron-btn:hover { background: rgba(30, 58, 95, 0.1); }
        .chevron-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .phase-badge { background: var(--primary); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; }
        
        /* Top Timeline */
        .timeline-wrapper {
            position: relative;
            height: 180px; /* Taller for waves */
            width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            margin-bottom: 30px;
            cursor: grab;
            background: linear-gradient(to right, transparent, rgba(30, 58, 95, 0.02) 50%, transparent);
            border-radius: var(--radius);
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge legacy */
        }
        .timeline-wrapper::-webkit-scrollbar { display: none; } /* Chrome/Safari */
        .timeline-wrapper:active { cursor: grabbing; }

        /* MAIN GRID LAYOUT */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        /* 3 Middle Cards (Hours, Deadlines, Mental State) */
        .metric-card {
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .metric-value { font-size: 2.5rem; font-weight: 700; color: var(--primary); font-family: var(--font-mono); }
        .metric-label { color: var(--text-secondary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        
        /* Bottom Row (Mindset, Priorities) */
        .bottom-row {
            display: grid;
            gap: 20px;
        }
        .bottom-row-secondary {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 20px;
        }

        /* Weekly Mindset Card Interaction */
        .mindset-card {
            background-color: var(--primary);
            color: white;
            cursor: pointer;
            position: relative;
            min-height: 250px;
            transition: transform 0.2s, box-shadow 0.2s;
            overflow: hidden;
            z-index: 0;
        }
        .mindset-card > * { position: relative; z-index: 1; }
        .mindset-card::after {
            content: "";
            position: absolute;
            inset: 0;
            pointer-events: none;
            opacity: 0.22;
            background-image:
                url('images/textures/navy-legal-texture.svg'),
                radial-gradient(rgba(255,255,255,0.10) 1px, transparent 1px),
                radial-gradient(rgba(0,0,0,0.12) 1px, transparent 1px),
                repeating-linear-gradient(135deg, rgba(255,255,255,0.05) 0 2px, transparent 2px 7px);
            background-repeat: repeat, repeat, repeat, repeat;
            background-size: 96px 96px, 6px 6px, 9px 9px, 100% 100%;
            background-position: center, 0 0, 3px 2px, center;
            mix-blend-mode: soft-light;
            z-index: 0;
        }
        .mindset-card:hover {
            transform: scale(1.01);
            box-shadow: 0 10px 30px rgba(30, 58, 95, 0.3);
        }
        
        .mindset-content {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .fade-out { opacity: 0; transform: translateY(-5px); }
        .fade-in { opacity: 1; transform: translateY(0); }

        /* Priorities Card Interaction */
        .priority-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
            border-radius: 8px;
        }
        .priority-item:hover { background: #f8fbff; }
        .priority-header { display: flex; justify-content: space-between; font-weight: 500; }
        .priority-detail { 
            font-size: 0.9rem; color: var(--text-secondary); margin-top: 8px; padding-top: 8px; border-top: 1px dashed #eee;
            display: none; 
        }
        .priority-item.active .priority-detail { display: block; animation: fadeIn 0.3s; }
        .priority-item.active { background: #f0f7ff; }

        /* Advice */
        .advice-box {
            margin-top: 16px;
            padding-top: 14px;
            border-top: 1px solid rgba(0,0,0,0.08);
        }
        .advice-title {
            font-size: 0.85rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }
        .advice-title-left { display: inline-flex; align-items: center; gap: 8px; }
        .advice-nav { display: inline-flex; align-items: center; gap: 8px; }
        .advice-counter { font-size: 0.8rem; color: var(--text-secondary); letter-spacing: 0.2px; }
        .advice-nav-btn {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            border: 1px solid rgba(30, 58, 95, 0.18);
            background: #ffffff;
            color: var(--primary);
            cursor: pointer;
            transition: background 0.15s ease, transform 0.15s ease, border-color 0.15s ease;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .advice-nav-btn:hover { background: rgba(30, 58, 95, 0.06); border-color: rgba(30, 58, 95, 0.30); transform: translateY(-1px); }
        .advice-nav-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
        .advice-card {
            background: linear-gradient(135deg, #ffffff 0%, #fffbf0 100%);
            border: 1px solid rgba(0,0,0,0.06);
            border-radius: 12px;
            padding: 12px 14px;
            cursor: pointer;
            user-select: none;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }
        .advice-card:hover { transform: translateY(-1px); box-shadow: 0 10px 20px rgba(0,0,0,0.06); }
        .advice-card:active { transform: translateY(0); }
        .advice-item-title { font-weight: 700; color: var(--primary); margin-bottom: 6px; }
        .advice-list {
            margin: 0;
            padding-left: 18px;
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.55;
        }
        .advice-list li { margin: 8px 0; }

        /* Mental State Card */
        .mental-state-card {
            position: relative;
            background: linear-gradient(135deg, #fff 0%, #fffbf0 100%);
            border-left: 4px solid var(--accent);
        }

        /* Progress Bar */
        .progress-container { height: 8px; background: #eee; border-radius: 4px; margin-top: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent); border-radius: 4px; transition: width 0.6s cubic-bezier(0.22, 1, 0.36, 1); }
        .progress-fill.primary { background: var(--primary); }

        /* Study Hours expand */
        .study-card { cursor: pointer; user-select: none; }
        .study-breakdown {
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px dashed rgba(0,0,0,0.10);
            display: grid;
            gap: 10px;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 220ms ease, opacity 220ms ease;
        }
        .study-card.expanded .study-breakdown {
            max-height: 260px;
            opacity: 1;
        }
        .class-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: center;
        }
        .class-name { font-weight: 600; color: var(--primary); }
        .class-meta { color: var(--text-secondary); font-size: 0.85rem; white-space: nowrap; }
        .class-progress { grid-column: 1 / -1; margin-top: 6px; }

        /* Settings form */
        .settings-grid {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 12px;
        }
        .settings-grid input[type="text"], .settings-grid input[type="number"] { padding: 10px; }
        .settings-hint { font-size: 0.85rem; color: var(--text-secondary); margin-top: -6px; }

        /* Responsive */
        @media (max-width: 900px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .bottom-row-secondary { grid-template-columns: 1fr; }
        }

        /* Modal */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0; pointer-events: none;
            transition: opacity 180ms ease-out;
            padding: 24px;
        }
        .modal-backdrop.active { opacity: 1; pointer-events: all; }
        .modal-content {
            background: var(--bg-secondary);
            padding: 32px;
            border-radius: 20px; /* ~rounded-2xl */
            width: 100%;
            max-width: 640px;
            max-height: calc(100vh - 48px);
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.35);
            border: 1px solid rgba(0,0,0,0.06);
            transform: translateY(8px) scale(0.98);
            transition: transform 180ms ease-out;
        }
        .modal-backdrop.active .modal-content { transform: translateY(0) scale(1); }

        @media (prefers-reduced-motion: reduce) {
            .modal-backdrop { transition: none; }
            .modal-content { transition: none; }
            .modal-backdrop.active { animation: none; }
            .modal-backdrop.active .modal-content { animation: none; }
        }

        @keyframes modalBackdropIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes modalCardIn { from { transform: translateY(12px) scale(0.97); } to { transform: translateY(0) scale(1); } }
        .modal-backdrop.active { animation: modalBackdropIn 180ms ease-out; }
        .modal-backdrop.active .modal-content { animation: modalCardIn 180ms ease-out; }

        /* Log Activity modal specifics */
        .modal-title {
            margin-bottom: 18px;
            color: var(--primary);
            font-weight: 700;
            letter-spacing: 0.2px;
        }
        .modal-subtitle {
            margin-top: -10px;
            margin-bottom: 20px;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        .btn-ghost {
            background: transparent;
            color: var(--primary);
            border: 1px solid rgba(30, 58, 95, 0.18);
        }
        .btn-ghost:hover {
            background: rgba(30, 58, 95, 0.06);
            border-color: rgba(30, 58, 95, 0.3);
        }
        .btn-save {
            background: var(--primary);
            color: var(--accent);
        }
        .btn-save:hover { background: var(--primary-light); transform: translateY(-1px); }

        .log-field-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .log-unit-suffix {
            color: var(--text-secondary);
            font-size: 0.95rem;
            white-space: nowrap;
        }

        input.range[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 10px;
            border-radius: 999px;
            padding: 0;
            border: 1px solid #e5e7eb;
            background: linear-gradient(to right, var(--accent) 0 var(--range-progress, 0%), #e5e7eb var(--range-progress, 0%) 100%);
        }
        input.range[type="range"]:focus { outline: none; border-color: rgba(30, 58, 95, 0.45); box-shadow: 0 0 0 4px rgba(30, 58, 95, 0.12); }
        input.range[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 999px;
            background: var(--accent);
            border: 3px solid white;
            box-shadow: 0 6px 14px rgba(0,0,0,0.18);
            cursor: pointer;
        }
        input.range[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 999px;
            background: var(--accent);
            border: 3px solid white;
            box-shadow: 0 6px 14px rgba(0,0,0,0.18);
            cursor: pointer;
        }
        input.range[type="range"]::-moz-range-track {
            height: 10px;
            border-radius: 999px;
            background: transparent;
            border: 0;
        }
        .range-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 8px;
            user-select: none;
        }

        /* Confessional Styling */
        .confessional-dialogue {
            background: #f4f6f8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .conf-speaker { font-weight: bold; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px; margin-bottom: 5px; display: block;}
        .speaker-frantic { color: var(--danger); }
        .speaker-therapist { color: var(--success); }

        /* Canvas */
        #confetti-canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 9999; }
    </style>
</head>
<body>

    <div id="app"></div>

    <!-- ONBOARDING TEMPLATE -->
    <template id="tmpl-onboarding">
        <div id="view-onboarding">
            <div class="step-container card animate-fade-in">
                <div class="step" data-step="1">
                    <h1 style="color:var(--primary); margin-bottom:10px;">1L Term Companion</h1>
                    <p class="text-secondary" style="margin-bottom:24px;">Navigate the fog, finding the groove, and surviving the triage of your first semester.</p>
                    <div class="flex flex-col gap-2">
                        <button class="btn btn-primary w-full" onclick="Onboarding.finish(true)">Load Recommended 1L Fall Plan</button>
                        <button class="btn btn-secondary w-full" onclick="Onboarding.next()">Custom Setup</button>
                    </div>
                </div>

                <div class="step hidden" data-step="2">
                    <h2>Custom Setup</h2>
                    <p class="text-secondary" style="margin-bottom:20px;">Standard semester is usually 14-15 weeks.</p>
                    <div class="input-group">
                        <label>Total Weeks</label>
                        <input type="number" id="setup-weeks" value="15" min="10" max="20">
                    </div>
                     <div class="input-group">
                        <label>Current Week</label>
                        <input type="number" id="setup-current" value="1" min="1" max="20">
                    </div>
                    <button class="btn btn-primary w-full" onclick="Onboarding.finish(false)">Start</button>
                </div>
            </div>
        </div>
    </template>

    <!-- DASHBOARD TEMPLATE -->
    <template id="tmpl-dashboard">
        <div id="view-dashboard" class="animate-fade-in">
            <!-- Header -->
            <header>
                <div class="week-nav">
                    <button class="chevron-btn" id="btn-prev-week" onclick="Dashboard.prevWeek()" title="Previous week">‚Äπ</button>
                    <div class="week-display">
                        <h2 class="text-primary" id="dash-title" style="margin: 0;">Week 1</h2>
                        <span class="phase-badge" id="dash-phase">The Fog</span>
                    </div>
                    <button class="chevron-btn" id="btn-next-week" onclick="Dashboard.nextWeek()" title="Next week">‚Ä∫</button>
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-secondary" onclick="Settings.open()">Settings</button>
                    <button class="btn btn-primary" onclick="Logger.open()">Log Activity</button>
                </div>
            </header>

            <!-- Top Timeline -->
            <div class="card timeline-wrapper" id="timeline-container"></div>

            <!-- Middle Grid -->
            <div class="dashboard-grid">
                <!-- 1. Study Hours -->
                <div class="card metric-card study-card" id="card-study" onclick="Dashboard.toggleStudyDetails()">
                    <div>
                        <div class="metric-label">Study Hours</div>
                        <div class="metric-value" id="stat-hours">0</div>
                        <div class="text-sm text-secondary">Goal: <span id="stat-goal">40</span> hrs</div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-fill" id="prog-hours" style="width: 0%"></div>
                    </div>
                    <div class="study-breakdown" id="study-breakdown" aria-hidden="true"></div>
                </div>

                <!-- 2. Critical Deadlines (Countdown) -->
                <div class="card metric-card">
                    <div class="metric-label">Critical Deadline</div>
                    <div class="text-center" style="margin: 10px 0;">
                        <div style="font-size: 1.8rem; font-weight: 700; color: var(--danger);" id="deadline-timer">14 Days</div>
                        <div class="text-secondary text-sm" id="deadline-label">Until Resume Drop</div>
                    </div>
                    <div id="deadline-progress-wrap" class="hidden">
                        <div class="text-sm text-secondary" id="deadline-progress-label" style="margin-top:6px;">Progress</div>
                        <div class="progress-container" style="margin-top: 8px;">
                            <div class="progress-fill" id="deadline-progress" style="width: 0%"></div>
                        </div>
                    </div>
                    <button class="btn btn-secondary" style="font-size: 0.8rem; padding: 6px;" onclick="Dashboard.showAllDeadlines()">View All</button>
                </div>

                <!-- 3. Mental State -->
                <div class="card metric-card mental-state-card">
                    <div>
                        <div class="metric-label">The Vibe</div>
                        <h3 id="vibe-title" style="font-size: 1.5rem; color: var(--primary);">Imposter Syndrome</h3>
                        <p id="vibe-sub" class="text-secondary text-sm" style="margin-top:5px;">Trust the process.</p>
                    </div>
                    <button class="btn btn-accent w-full" style="margin-top: 15px;" onclick="Dashboard.openConfessional()">Venting? üõãÔ∏è</button>
                </div>
            </div>

            <!-- Bottom Row -->
            <div class="bottom-row">
                <!-- 4. Weekly Mindset (Interactive) -->
                <div class="card mindset-card" onclick="Dashboard.rotateMindset()">
                    <div class="metric-label" style="color: rgba(255,255,255,0.7);">Weekly Mindset</div>
                    <div id="mindset-container" class="flex flex-col justify-center" style="height: 100%; min-height: 150px;">
                        <h3 id="mindset-type" style="text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; opacity: 0.8; margin-bottom: 10px;">Philosophical Check</h3>
                        <p id="mindset-text" style="font-size: 1.4rem; font-style: italic; line-height: 1.4;">"Admissions doesn't make mistakes. You are here because you are capable."</p>
                    </div>
                    <div style="position: absolute; bottom: 15px; right: 20px; font-size: 0.8rem; opacity: 0.5;">Click to rotate ‚Üª</div>
                </div>

                <div class="bottom-row-secondary">
                    <!-- 5. Priorities -->
                    <div class="card">
                        <div class="metric-label">Priorities & Actions</div>
                        <div id="priorities-list" class="flex flex-col gap-2">
                            <!-- Populated via JS -->
                        </div>
                    </div>

                    <!-- 6. Study Strategy -->
                    <div class="card">
                        <div class="metric-label">Study Strategy</div>
                        <div class="advice-box" style="margin-top: 10px; padding-top: 0; border-top: 0;">
                            <div class="advice-title" style="margin-bottom: 12px;">
                                <span class="advice-title-left">Quick Advice</span>
                                <span class="advice-nav">
                                    <span class="advice-counter" id="advice-counter">1 / 5</span>
                                    <button class="advice-nav-btn" type="button" id="advice-prev" onclick="Dashboard.prevAdvice()" aria-label="Previous advice">‚Äπ</button>
                                    <button class="advice-nav-btn" type="button" id="advice-next" onclick="Dashboard.nextAdvice()" aria-label="Next advice">‚Ä∫</button>
                                </span>
                            </div>
                            <div class="advice-card" id="advice-card" onclick="Dashboard.nextAdvice()" role="button" tabindex="0" aria-label="Next advice">
                                <div class="advice-item-title" id="advice-item-title"></div>
                                <div class="text-secondary" id="advice-item-body"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- CONFESSIONAL MODAL -->
    <div id="modal-confessional" class="modal-backdrop">
        <div class="modal-content">
            <h2 style="margin-bottom: 10px; color: var(--primary);">Couch Confessional</h2>
            <p style="margin-bottom: 20px; font-style: italic; color: var(--text-secondary);">What you're feeling vs. What is true.</p>
            
            <div class="confessional-dialogue">
                <span class="conf-speaker speaker-frantic">The Frantic 1L</span>
                <p id="conf-frantic">"I walked into Legal Methods and everyone was wearing suits. Did I miss a memo?"</p>
            </div>

            <div class="confessional-dialogue" style="background: #f0fff4; border: 1px solid #c6f6d5;">
                <span class="conf-speaker speaker-therapist">The Rebuttal</span>
                <p id="conf-rebuttal">Suits are fear. The person talking the most in Week 1 is rarely the person getting the highest grade.</p>
            </div>

            <button class="btn btn-primary w-full" onclick="document.getElementById('modal-confessional').classList.remove('active')">Close</button>
        </div>
    </div>

    <!-- LOGGING MODAL -->
    <div id="modal-log" class="modal-backdrop">
        <div class="modal-content">
            <h2 class="modal-title">Log Activity</h2>
            <p class="modal-subtitle">Add focused work time for today.</p>
            <div class="input-group">
                <label for="log-class">Class</label>
                <select id="log-class" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:1rem;"></select>
                <div class="settings-hint" style="margin-top:8px;">Tip: set class names and goals in Settings.</div>
            </div>
            <div class="input-group">
                <label for="log-hours-input">Hours/Units</label>
                <div class="log-field-row">
                    <input type="number" id="log-hours-input" min="0" max="12" step="0.5" value="0" inputmode="decimal" aria-describedby="log-hours-help">
                    <span class="log-unit-suffix" id="log-hours-help">0‚Äì12</span>
                </div>
                <div style="margin-top: 14px;">
                    <input class="range" type="range" id="log-hours-range" min="0" max="12" step="0.5" value="0">
                    <div class="range-meta"><span>0</span><span>12</span></div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-ghost w-full" type="button" onclick="Logger.close()">Cancel</button>
                <button class="btn btn-save w-full" type="button" onclick="Logger.save()">
                    <span style="display:inline-flex; align-items:center; gap:10px; justify-content:center;">
                        Save
                        <svg width="16" height="16" viewBox="0 0 20 20" fill="none" aria-hidden="true">
                            <path d="M6.5 10.5L8.75 12.75L13.75 7.75" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </span>
                </button>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="modal-settings" class="modal-backdrop">
        <div class="modal-content">
            <h2 style="margin-bottom: 12px; color: var(--primary);">Settings</h2>
            <p class="settings-hint" style="margin-bottom: 18px;">Set up to 4 classes and weekly hour goals.</p>

            <div class="settings-grid">
                <div>
                    <label class="text-sm text-secondary" for="set-class-name-1">Class 1</label>
                    <input type="text" id="set-class-name-1" placeholder="e.g., Contracts">
                </div>
                <div>
                    <label class="text-sm text-secondary" for="set-class-goal-1">Weekly Goal</label>
                    <input type="number" id="set-class-goal-1" min="0" step="0.5" placeholder="hrs">
                </div>

                <div>
                    <label class="text-sm text-secondary" for="set-class-name-2">Class 2</label>
                    <input type="text" id="set-class-name-2" placeholder="e.g., Torts">
                </div>
                <div>
                    <label class="text-sm text-secondary" for="set-class-goal-2">Weekly Goal</label>
                    <input type="number" id="set-class-goal-2" min="0" step="0.5" placeholder="hrs">
                </div>

                <div>
                    <label class="text-sm text-secondary" for="set-class-name-3">Class 3</label>
                    <input type="text" id="set-class-name-3" placeholder="e.g., Civil Procedure">
                </div>
                <div>
                    <label class="text-sm text-secondary" for="set-class-goal-3">Weekly Goal</label>
                    <input type="number" id="set-class-goal-3" min="0" step="0.5" placeholder="hrs">
                </div>

                <div>
                    <label class="text-sm text-secondary" for="set-class-name-4">Class 4</label>
                    <input type="text" id="set-class-name-4" placeholder="e.g., Legal Practice Workshop">
                </div>
                <div>
                    <label class="text-sm text-secondary" for="set-class-goal-4">Weekly Goal</label>
                    <input type="number" id="set-class-goal-4" min="0" step="0.5" placeholder="hrs">
                </div>
            </div>

            <div class="modal-actions" style="margin-top: 22px;">
                <button class="btn btn-secondary w-full" onclick="Store.reset(); location.reload()">Reset All Data</button>
                <button class="btn btn-primary w-full" onclick="Settings.save()">Save</button>
            </div>
            <button class="btn btn-ghost w-full" style="margin-top: 12px;" onclick="Settings.close()">Close</button>
        </div>
    </div>

    <script>
        /* --- 1. CONTENT ENGINE (The Brain) --- */
        const SemesterContent = {
            weeks: {
                1: {
                    phase: "Orientation",
                    color: "var(--primary)",
                    vibe: "Imposter Syndrome",
                    vibeSub: "The suits are a lie.",
                    mindset: [
                        { type: "The Hard Truth", text: "You are not here to be smart. You are here to become a person who can read a 90-page contract in a language you hate." },
                        { type: "Reality Check", text: "The person raising their hand every 5 minutes is performing anxiety. You are performing retention. You win." },
                        { type: "Counsel", text: "You feel stupid because you are climbing a mountain. If it was flat, you'd be bored." }
                    ],
                    deadline: { title: "IRAC Mastery", time: "Warning: Critical" },
                    priorities: [
                        { label: "Legal Methods: Brief fully", detail: "Learn IRAC immediately. This is the only class that matters right now." },
                        { label: "Social: Don't be 'That Guy'", detail: "Watch, listen, and learn names. Do not argue with the professor." },
                        { label: "Logistics: Survival Kit", detail: "Get your locker, painkillers, and noise-canceling headphones sorted." }
                    ],
                    confessional: {
                        frantic: "Everyone else seems to know what's going on. I'm the diversity hire/error/luckiest idiot here.",
                        rebuttal: "Admissions doesn't make mistakes. You are currently competent at being a normal human; law school requires you to be incompetent at a new skill first."
                    }
                },
                2: {
                    phase: "Classes Start",
                    color: "var(--primary)",
                    vibe: "Cold Call Shock",
                    vibeSub: "It's just public speaking.",
                    mindset: [
                        { type: "The Hard Truth", text: "A cold call is not an IQ test. It is a hazing ritual to see if you can speak while terrified." },
                        { type: "Reality Check", text: "You will get it wrong. The professor expects you to get it wrong. It's the Socratic Method, not a quiz show." },
                        { type: "Counsel", text: "Your worth is not defined by whether you knew the holding in Palsgraf." }
                    ],
                    deadline: { title: "Club Fair", time: "Friday" },
                    priorities: [
                        { label: "Briefing: Deep Dive", detail: "Read everything. Look up words you don't know (Black's Law Dict)." },
                        { label: "Cold Call Prep", detail: "Have a one-sheet summary of the facts for every case on your desk." },
                        { label: "Budget: Lock it down", detail: "Bar reviews are expensive. Set a weekly limit now." }
                    ],
                    confessional: {
                        frantic: "I froze. I mumbled. I looked like an idiot.",
                        rebuttal: "You survived. Nobody cares. By lunch, they were worrying about their own cold calls."
                    }
                },
                4: {
                    phase: "The Grind",
                    color: "var(--primary)",
                    vibe: "The Fog",
                    vibeSub: "Just keep swimming.",
                    mindset: [
                        { type: "The Hard Truth", text: "If you are bored, you are doing it right. The law is technical and slow." },
                        { type: "Reality Check", text: "Don't date within your section. Just... trust me on this." },
                        { type: "Counsel", text: "Confusion is the curriculum. The 'click' happens in November, not September." }
                    ],
                    deadline: { title: "Outline Prep", time: "Soon" },
                    priorities: [
                        { label: "Routine: Sleep is work", detail: "7 hours minimum. A tired brain cannot synthesize rules." },
                        { label: "Social: The Saturday Rule", detail: "Take 24 hours off. Totally off. No guilt." },
                        { label: "Reading: Identify Rules", detail: "Start distinguishing betwen 'Dicta' (fluff) and 'Holding' (rule)." }
                    ],
                    confessional: {
                        frantic: "I have 400 pages to read and I only understand 10 of them.",
                        rebuttal: "Read for the rule. You don't need to memorize the judge's life story."
                    }
                },
                6: {
                    phase: "The Slump",
                    color: "var(--accent)",
                    vibe: "Comparison Spiral",
                    vibeSub: "Stay in your lane.",
                    mindset: [
                        { type: "The Hard Truth", text: "If you compare your insides to everyone else's Instagram outsides, you will fail." },
                        { type: "Reality Check", text: "That guy with the 40-page outline? He just transcribed the textbook. He knows nothing." },
                        { type: "Counsel", text: "This is the blurry middle. You don't see the shore. Keep rowing." }
                    ],
                    deadline: { title: "Resume Final", time: "Oct 15" },
                    priorities: [
                        { label: "Network: Tactical", detail: "Email 2 alumni. Ask 'What do you do all day?' not 'Can I have a job?'" },
                        { label: "Supplements: E&E", detail: "Buy 'Examples & Explanations'. It explains what your professor won't." },
                        { label: "Office Hours", detail: "Go once. Ask one good question. Leave." }
                    ],
                    confessional: {
                        frantic: "I feel like everyone is secretly ahead of me.",
                        rebuttal: "The 'Duck Syndrome': Everyone is calm on top and paddling furiously underwater."
                    }
                },
                9: {
                    phase: "The Shift",
                    color: "var(--accent)",
                    vibe: "Outlining",
                    vibeSub: "Synthesis mode.",
                    mindset: [
                        { type: "The Hard Truth", text: "An outline is a verb, not a noun. If you buy one, you learn nothing." },
                        { type: "Reality Check", text: "Midterms don't matter. They are a fire drill." },
                        { type: "Counsel", text: "You are building a map of the forest. Stop staring at the bark of the trees." }
                    ],
                    deadline: { title: "First Draft Outline", time: "Nov 1" },
                    priorities: [
                        { label: "Outlining: Start NOW", detail: "Condense your notes. organize by topic, not by case name." },
                        { label: "Health: Immunity", detail: "Get a flu shot. You cannot be sick during finals." },
                        { label: "Apps: Polish", detail: "Finalize cover letters for Dec 1 firm applications." }
                    ],
                    confessional: {
                        frantic: "I'm so behind. I'll never catch up.",
                        rebuttal: "You are not behind. You are exactly where you need to be. Just start typing."
                    }
                },
                11: {
                    phase: "Triage",
                    color: "var(--danger)",
                    vibe: "Burnout",
                    vibeSub: "Survival of the fittest.",
                    mindset: [
                        { type: "The Hard Truth", text: "Nobody reads the footnotes in November. Skim it." },
                        { type: "Reality Check", text: "Your body is an engine. Put good fuel in it or it will stall on the highway." },
                        { type: "Counsel", text: "The 1L 15 is real. Forgive yourself for eating the bagel. Focus on the exam." }
                    ],
                    deadline: { title: "Thanksgiving", time: "Break" },
                    priorities: [
                        { label: "Study: Book Briefing", detail: "Stop writing full briefs. Highlight the book. Save time." },
                        { label: "Practice: Hypos", detail: "Do one practice problem a day. Get used to applying the law." },
                        { label: "Social: Ghost Mode", detail: "Stop going to events. Stop networking. Focus." }
                    ],
                    confessional: {
                        frantic: "I just want to sleep for a week.",
                        rebuttal: "This is the wall. Push through it. The break is coming."
                    }
                },
                14: {
                    phase: "Finals",
                    color: "var(--danger)",
                    vibe: "The Void",
                    vibeSub: "Game day.",
                    mindset: [
                        { type: "The Hard Truth", text: "You can stand on your head for 3 hours if the salary is right." },
                        { type: "Reality Check", text: "The curve is a safety net. It is actually very hard to fail." },
                        { type: "Counsel", text: "One grade does not define a career. Even if you trip, you are still at Columbia." }
                    ],
                    deadline: { title: "FINAL EXAM", time: "Dec 10" },
                    priorities: [
                        { label: "Exam: Timed Runs", detail: "Take full 3-4 hour practice exams. Under time pressure." },
                        { label: "Formatting: IRAC", detail: "Use headers. Argue both sides. Conclusion doesn't matter, analysis does." },
                        { label: "Life: Bland Food", detail: "Eat safe foods. Sleep 8 hours. Don't crash before the finish line." }
                    ],
                    confessional: {
                        frantic: "If I don't get an A, I'll die alone under a bridge.",
                        rebuttal: "You will not die under a bridge. You will be a lawyer. Breathe."
                    }
                }
            },
            
            get(week) {
                let keys = Object.keys(this.weeks).map(Number).sort((a,b)=>a-b);
                let best = keys[0];
                for(let k of keys) {
                    if (k <= week) best = k;
                }
                return this.weeks[best];
            }
        };

        /* --- 2. STATE --- */
        const Store = {
            key: 'law_dashboard_v3', /* CHANGED KEY TO FORCE RESET & FIX DATA ISSUES */
            state: {
                setup: false,
                currentWeek: 1,
                totalWeeks: 15,
                goalHours: 40, /* legacy fallback */
                classes: [
                    { id: 'c1', name: 'Contracts', goalHours: 10 },
                    { id: 'c2', name: 'Torts', goalHours: 10 },
                    { id: 'c3', name: 'Civil Procedure', goalHours: 10 },
                    { id: 'c4', name: 'Legal Practice Workshop', goalHours: 10 }
                ],
                weeksData: {} 
            },

            getActiveClasses() {
                const list = Array.isArray(this.state.classes) ? this.state.classes : [];
                return list.filter(c => (c?.name || '').trim().length > 0);
            },
            getTotalGoal() {
                const classes = this.getActiveClasses();
                const sum = classes.reduce((acc, c) => acc + (parseFloat(c.goalHours) || 0), 0);
                return sum > 0 ? sum : (parseFloat(this.state.goalHours) || 40);
            },
            
            init() {
                try {
                    const s = localStorage.getItem(this.key);
                    if(s) {
                        const parsed = JSON.parse(s);
                        // Simple validation
                        if(parsed.currentWeek && parsed.weeksData) {
                            this.state = parsed;

                            // Migration: ensure classes exist
                            if (!Array.isArray(this.state.classes) || this.state.classes.length === 0) {
                                this.state.classes = [
                                    { id: 'c1', name: 'Contracts', goalHours: 10 },
                                    { id: 'c2', name: 'Torts', goalHours: 10 },
                                    { id: 'c3', name: 'Civil Procedure', goalHours: 10 },
                                    { id: 'c4', name: 'Legal Practice Workshop', goalHours: 10 }
                                ];
                            }

                            // Migration: weeksData[w].hours -> weeksData[w].byClass
                            const firstId = (this.state.classes?.[0]?.id) || 'c1';
                            Object.keys(this.state.weeksData || {}).forEach((wk) => {
                                const entry = this.state.weeksData[wk] || {};
                                if (typeof entry.hours === 'number' && !entry.byClass) {
                                    entry.byClass = { [firstId]: entry.hours };
                                    delete entry.hours;
                                    this.state.weeksData[wk] = entry;
                                }
                                if (!entry.byClass) entry.byClass = {};
                            });
                        }
                    }
                } catch(e) {
                    console.error("State load failed", e);
                    this.reset();
                }
            },
            save() {
                localStorage.setItem(this.key, JSON.stringify(this.state));
                Dashboard.render();
            },
            reset() { 
                localStorage.removeItem(this.key); 
            },
            
            getWeekStats(w) {
                if(!this.state.weeksData) this.state.weeksData = {};
                if(!this.state.weeksData[w]) this.state.weeksData[w] = { byClass: {} };
                if(!this.state.weeksData[w].byClass) this.state.weeksData[w].byClass = {};
                const byClass = this.state.weeksData[w].byClass;
                const total = Object.values(byClass).reduce((acc, v) => acc + (parseFloat(v) || 0), 0);
                return { byClass, total };
            },
            addHours(classId, h) {
                const entry = (this.state.weeksData[this.state.currentWeek] ||= { byClass: {} });
                entry.byClass ||= {};
                const key = classId || (this.state.classes?.[0]?.id) || 'c1';
                entry.byClass[key] = (parseFloat(entry.byClass[key]) || 0) + (parseFloat(h) || 0);
                this.save();
            }
        };

        /* --- 3. ONBOARDING --- */
        const Onboarding = {
            init() { /* no op */ },
            next() {
                document.querySelector('[data-step="1"]').classList.add('hidden');
                document.querySelector('[data-step="2"]').classList.remove('hidden');
            },
            finish(isDefault) {
                try {
                    Store.state.setup = true;
                    Store.state.currentWeek = 1;
                    Store.state.totalWeeks = isDefault ? 15 : parseInt(document.getElementById('setup-weeks').value || 15);
                    Store.state.weeksData = {}; // Clear old data if any
                    Store.save();
                    Router.render('tmpl-dashboard');
                    Dashboard.init();
                } catch(e) {
                    alert("Error starting setup: " + e.message);
                }
            }
        };

        /* --- 4. DASHBOARD CONTROLLER --- */
        const Dashboard = {
            mindsetSlot: 0,
            studyExpanded: false,
            adviceIndex: 0,

            init() {
                this.render();
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'ArrowRight') this.nextWeek();
                    if (e.key === 'ArrowLeft') this.prevWeek();
                });
            },

            goto(n) {
                Store.state.currentWeek = n;
                Store.save();
            },

            nextWeek() {
                if(Store.state.currentWeek < Store.state.totalWeeks) {
                    this.goto(Store.state.currentWeek + 1);
                }
            },
            prevWeek() {
                if(Store.state.currentWeek > 1) {
                    this.goto(Store.state.currentWeek - 1);
                }
            },

            // --- INTERACTION HANDLERS ---
            rotateMindset() {
                const content = SemesterContent.get(Store.state.currentWeek);
                this.mindsetSlot = (this.mindsetSlot + 1) % 3;
                
                const container = document.getElementById('mindset-container');
                container.classList.add('fade-out');
                
                setTimeout(() => {
                    const data = content.mindset[this.mindsetSlot];
                    document.getElementById('mindset-type').innerText = data.type;
                    document.getElementById('mindset-text').innerText = `"${data.text}"`;
                    container.classList.remove('fade-out');
                    container.classList.add('fade-in');
                    setTimeout(() => container.classList.remove('fade-in'), 300);
                }, 200);
            },

            togglePriority(el) {
                const detail = el.querySelector('.priority-detail');
                const isHidden = getComputedStyle(detail).display === 'none';
                document.querySelectorAll('.priority-item').forEach(i => i.classList.remove('active'));
                if(isHidden) el.classList.add('active');
            },

            openConfessional() {
                const content = SemesterContent.get(Store.state.currentWeek);
                document.getElementById('conf-frantic').innerText = `"${content.confessional.frantic}"`;
                document.getElementById('conf-rebuttal').innerText = content.confessional.rebuttal;
                document.getElementById('modal-confessional').classList.add('active');
            },

            showAllDeadlines() {
                alert("This would open the full semester calendar view.");
            },
            toggleStudyDetails() {
                this.studyExpanded = !this.studyExpanded;
                const card = document.getElementById('card-study');
                const breakdown = document.getElementById('study-breakdown');
                if (card) card.classList.toggle('expanded', this.studyExpanded);
                if (breakdown) breakdown.setAttribute('aria-hidden', String(!this.studyExpanded));
            },
            getAdviceItems() {
                return [
                    {
                        title: "Study Groups (Use Them for Output)",
                        body: "Study groups are most useful for swapping notes and getting feedback on practice exams. If it turns into chatting, leave early and protect your time."
                    },
                    {
                        title: "Try and Iterate",
                        body: "There‚Äôs nothing wrong with studying with someone once‚Äîand then never studying with them again. Keep trying new combos until you find your people."
                    },
                    {
                        title: "Exam Focus Early (80/20)",
                        body: "Ask upperclassmen who took your professor what topics actually drive the exam. Commit ~80% of your study time to those and don‚Äôt get pulled into rabbit holes."
                    },
                    {
                        title: "Learn the Form First",
                        body: "As early as possible, read one past exam and a model answer. The next day, write your own. Repeat until your structure and style match the model‚Äîdoctrine comes later."
                    },
                    {
                        title: "Supplements: Use With Caution",
                        body: "Quimbee and supplements can teach extra doctrine your professor won‚Äôt test. Use them sparingly and always prioritize your class notes and past exams."
                    }
                ];
            },
            renderAdvice() {
                const items = this.getAdviceItems();
                const n = items.length || 1;
                if (this.adviceIndex >= n) this.adviceIndex = 0;
                if (this.adviceIndex < 0) this.adviceIndex = n - 1;

                const item = items[this.adviceIndex] || items[0];
                const titleEl = document.getElementById('advice-item-title');
                const bodyEl = document.getElementById('advice-item-body');
                const counterEl = document.getElementById('advice-counter');
                const prevBtn = document.getElementById('advice-prev');
                const nextBtn = document.getElementById('advice-next');
                const card = document.getElementById('advice-card');

                if (titleEl) titleEl.innerText = item.title || '';
                if (bodyEl) bodyEl.innerText = item.body || '';
                if (counterEl) counterEl.innerText = `${this.adviceIndex + 1} / ${n}`;
                if (prevBtn) prevBtn.disabled = n <= 1;
                if (nextBtn) nextBtn.disabled = n <= 1;

                if (card && !card.dataset.bound) {
                    card.dataset.bound = '1';
                    card.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            this.nextAdvice();
                        }
                    });
                }
            },
            nextAdvice() {
                this.adviceIndex += 1;
                this.renderAdvice();
            },
            prevAdvice() {
                this.adviceIndex -= 1;
                this.renderAdvice();
            },

            // --- RENDERER ---
            setText(id, text) {
                const el = document.getElementById(id);
                if(el) el.innerText = text;
                else console.warn('Missing element:', id);
            },

            render() {
                try {
                    const wk = Store.state.currentWeek;
                    const stats = Store.getWeekStats(wk);
                    const content = SemesterContent.get(wk);
                    const totalGoal = Store.getTotalGoal();
                    const activeClasses = Store.getActiveClasses();

                    // 1. Header
                    this.setText('dash-title', `Week ${wk}`);
                    this.setText('dash-phase', content.phase);
                    const phaseEl = document.getElementById('dash-phase');
                    if(phaseEl) phaseEl.style.background = content.color;
                    
                    document.getElementById('btn-prev-week').disabled = wk <= 1;
                    document.getElementById('btn-next-week').disabled = wk >= Store.state.totalWeeks;

                    // 2. Stats
                    this.setText('stat-hours', (stats.total || 0).toFixed(1).replace(/\.0$/, ''));
                    this.setText('stat-goal', totalGoal.toFixed(1).replace(/\.0$/, ''));
                    const pct = Math.min(100, ((stats.total||0) / totalGoal)*100);
                    const progEl = document.getElementById('prog-hours');
                    if(progEl) progEl.style.width = `${pct}%`;

                    // 2b. Study breakdown
                    const breakdown = document.getElementById('study-breakdown');
                    if (breakdown) {
                        breakdown.innerHTML = '';
                        activeClasses.forEach((c) => {
                            const hours = parseFloat(stats.byClass?.[c.id]) || 0;
                            const goal = parseFloat(c.goalHours) || 0;
                            const p = goal > 0 ? Math.min(100, (hours / goal) * 100) : 0;
                            const row = document.createElement('div');
                            row.className = 'class-row';
                            row.innerHTML = `
                                <div class="class-name">${c.name}</div>
                                <div class="class-meta">${hours.toFixed(1).replace(/\\.0$/, '')} / ${goal.toFixed(1).replace(/\\.0$/, '')} hrs</div>
                                <div class="progress-container class-progress">
                                    <div class="progress-fill primary" style="width:${p.toFixed(0)}%"></div>
                                </div>
                            `;
                            breakdown.appendChild(row);
                        });
                    }

                    // 3. Deadlines
                    this.setText('deadline-timer', content.deadline.time);
                    this.setText('deadline-label', `Until ${content.deadline.title}`);
                    const deadlineTimer = document.getElementById('deadline-timer');
                    if (deadlineTimer) {
                        const isWarning = String(content.deadline.time || '').toLowerCase().includes('warning');
                        deadlineTimer.style.color = isWarning ? 'var(--accent)' : 'var(--danger)';
                    }

                    const deadlineWrap = document.getElementById('deadline-progress-wrap');
                    const deadlineProg = document.getElementById('deadline-progress');
                    const deadlineProgLabel = document.getElementById('deadline-progress-label');
                    if (deadlineWrap && deadlineProg && deadlineProgLabel) {
                        if (content.deadline.title === 'IRAC Mastery') {
                            deadlineWrap.classList.remove('hidden');
                            const dpct = Math.min(100, ((stats.total || 0) / totalGoal) * 100);
                            deadlineProg.style.width = `${dpct}%`;
                            deadlineProgLabel.innerText = `IRAC mastery progress: ${dpct.toFixed(0)}%`;
                        } else {
                            deadlineWrap.classList.add('hidden');
                        }
                    }

                    // 4. Mental State
                    this.setText('vibe-title', content.vibe);
                    this.setText('vibe-sub', content.vibeSub);
                    const vibeCard = document.querySelector('.mental-state-card');
                    if(vibeCard) vibeCard.style.borderLeftColor = content.color;

                    // 5. Mindset
                    if(!this.mindsetRendering) {
                         const mData = content.mindset[0];
                         this.setText('mindset-type', mData.type);
                         this.setText('mindset-text', `"${mData.text}"`);
                         const mCard = document.querySelector('.mindset-card');
                         if(mCard) mCard.style.backgroundColor = content.color;
                         this.mindsetSlot = 0;
                    }

                    // 6. Priorities
                    const pList = document.getElementById('priorities-list');
                    if(pList) {
                        pList.innerHTML = '';
                        content.priorities.forEach(p => {
                            const div = document.createElement('div');
                            div.className = 'priority-item';
                            div.onclick = function() { Dashboard.togglePriority(this) };
                            div.innerHTML = `
                                <div class="priority-header">
                                    <span>${p.label}</span>
                                    <span style="color:var(--primary)">+</span>
                                </div>
                                <div class="priority-detail">${p.detail}</div>
                            `;
                            pList.appendChild(div);
                        });
                    }

                    // 6b. Advice (click-through)
                    this.renderAdvice();

                    // 7. Timeline
                    Timeline.draw('timeline-container', Store.state.totalWeeks, wk);
                } catch(e) {
                    console.error("Render error:", e);
                }
            }
        };

        const Timeline = {
            draw(containerId, totalWeeks, currentWeek) {
                const container = document.getElementById(containerId);
                if(!container) return;

                const containerWidth = container.offsetWidth || 800;
                const width = Math.max(containerWidth, 800, (totalWeeks * 60) + 80);
                const height = 150;
                const paddingX = 40;

                // Single cubic-bezier "wave" (stock-trend style):
                // Start low left ‚Üí rise mid ‚Üí dip slightly ‚Üí end higher right.
                const P0 = { x: paddingX, y: 112 };
                const P1 = { x: Math.round(width * 0.26), y: 22 };
                const P2 = { x: Math.round(width * 0.68), y: 138 };
                const P3 = { x: width - paddingX, y: 55 };

                const cubicPoint = (t) => {
                    const u = 1 - t;
                    const x = (u*u*u*P0.x) + (3*u*u*t*P1.x) + (3*u*t*t*P2.x) + (t*t*t*P3.x);
                    const y = (u*u*u*P0.y) + (3*u*u*t*P1.y) + (3*u*t*t*P2.y) + (t*t*t*P3.y);
                    return { x, y };
                };

                const pathD = `M ${P0.x} ${P0.y} C ${P1.x} ${P1.y} ${P2.x} ${P2.y} ${P3.x} ${P3.y}`;

                const progressPct = totalWeeks <= 1
                    ? 100
                    : Math.max(0, Math.min(100, ((currentWeek - 1) / (totalWeeks - 1)) * 100));

                const labelY = (pt) => Math.min(height - 10, pt.y + 28);

                let svg = `<svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">`;

                // Base future line (light gray)
                svg += `<path d="${pathD}" fill="none" stroke="#e5e7eb" stroke-width="2" stroke-linecap="round" />`;

                // Progress line (navy) that "draws" to the current week on load
                const drawDurMs = 650; // constant time regardless of target week
                const drawTo = `${progressPct.toFixed(2)} 100`;
                svg += `
                    <path d="${pathD}" fill="none" stroke="var(--primary)" stroke-width="3" stroke-linecap="round"
                          pathLength="100" stroke-dasharray="0 100">
                        <animate attributeName="stroke-dasharray" from="0 100" to="${drawTo}" dur="${drawDurMs}ms" fill="freeze" />
                    </path>
                `;

                // Nodes + labels (interactive)
                for (let i = 0; i < totalWeeks; i++) {
                    const weekNum = i + 1;
                    const t = totalWeeks === 1 ? 1 : (i / (totalWeeks - 1));
                    const pt = cubicPoint(t);
                    const isFuture = weekNum > currentWeek;
                    const isCurrent = weekNum === currentWeek;

                    const radius = isCurrent ? 9 : 7;

                    // Tooltip content for future nodes
                    let tip = '';
                    const direct = SemesterContent.weeks[weekNum];
                    if (direct?.deadline?.title) tip = `${direct.deadline.title}${direct.deadline.time ? ` ‚Ä¢ ${direct.deadline.time}` : ''}`;

                    if (isCurrent) {
                        svg += `
                            <circle cx="${pt.x.toFixed(1)}" cy="${pt.y.toFixed(1)}" r="16" fill="var(--primary)" opacity="0.14">
                                <animate attributeName="r" values="12;18;12" dur="1.8s" repeatCount="indefinite" />
                                <animate attributeName="opacity" values="0.18;0.02;0.18" dur="1.8s" repeatCount="indefinite" />
                            </circle>
                            <circle cx="${pt.x.toFixed(1)}" cy="${pt.y.toFixed(1)}" r="${radius}" fill="var(--primary)" stroke="#ffffff" stroke-width="3"
                                    style="cursor:pointer" onclick="Dashboard.goto(${weekNum})">
                                <animate attributeName="r" values="${radius};${radius + 1.2};${radius}" dur="1.8s" repeatCount="indefinite" />
                            </circle>
                        `;
                    } else if (isFuture) {
                        svg += `
                            <circle cx="${pt.x.toFixed(1)}" cy="${pt.y.toFixed(1)}" r="${radius}" fill="#ffffff" stroke="#e5e7eb" stroke-width="2"
                                    style="cursor:pointer" onclick="Dashboard.goto(${weekNum})">
                                ${tip ? `<title>${tip}</title>` : ''}
                            </circle>
                        `;
                    } else {
                        svg += `
                            <circle cx="${pt.x.toFixed(1)}" cy="${pt.y.toFixed(1)}" r="${radius}" fill="var(--primary)" stroke="var(--primary)" stroke-width="2"
                                    style="cursor:pointer" onclick="Dashboard.goto(${weekNum})"></circle>
                        `;
                    }

                    svg += `<text x="${pt.x.toFixed(1)}" y="${labelY(pt).toFixed(1)}" text-anchor="middle" fill="var(--text-secondary)" font-size="12" style="user-select:none;">W${weekNum}</text>`;
                }

                svg += `</svg>`;
                container.innerHTML = svg;

                if (currentWeek > 2) {
                    const t = (currentWeek - 1) / (totalWeeks - 1);
                    const pt = cubicPoint(t);
                    const scrollX = pt.x - (container.offsetWidth / 2);
                    container.scrollLeft = Math.max(0, scrollX);
                }
            }
        };

        const Settings = {
            open() {
                const modal = document.getElementById('modal-settings');
                modal.classList.add('active');
                const classes = Store.state.classes || [];
                for (let i = 1; i <= 4; i++) {
                    const c = classes[i - 1] || { name: '', goalHours: 0 };
                    const nameEl = document.getElementById(`set-class-name-${i}`);
                    const goalEl = document.getElementById(`set-class-goal-${i}`);
                    if (nameEl) nameEl.value = c.name || '';
                    if (goalEl) goalEl.value = (c.goalHours ?? 0);
                }
            },
            close() { document.getElementById('modal-settings').classList.remove('active'); },
            save() {
                const next = [];
                for (let i = 1; i <= 4; i++) {
                    const name = (document.getElementById(`set-class-name-${i}`)?.value || '').trim();
                    const goal = parseFloat(document.getElementById(`set-class-goal-${i}`)?.value || '0') || 0;
                    next.push({ id: `c${i}`, name, goalHours: goal });
                }
                Store.state.classes = next;
                Store.save();
                this.close();
            }
        }

        const Router = {
            render(tmplId) {
                document.getElementById('app').innerHTML = '';
                const clone = document.getElementById(tmplId).content.cloneNode(true);
                document.getElementById('app').appendChild(clone);
            }
        };

        const Logger = {
            _clamp(val, min, max) { return Math.min(max, Math.max(min, val)); },
            _setRangeProgress(rangeEl) {
                const min = parseFloat(rangeEl.min || '0');
                const max = parseFloat(rangeEl.max || '100');
                const val = parseFloat(rangeEl.value || '0');
                const pct = ((val - min) / (max - min)) * 100;
                rangeEl.style.setProperty('--range-progress', `${pct}%`);
            },
            _sync(val) {
                const input = document.getElementById('log-hours-input');
                const range = document.getElementById('log-hours-range');
                const min = parseFloat(range.min);
                const max = parseFloat(range.max);
                const clamped = this._clamp(val, min, max);
                input.value = String(clamped);
                range.value = String(clamped);
                this._setRangeProgress(range);
            },
            open() {
                const modal = document.getElementById('modal-log');
                modal.classList.add('active');

                const input = document.getElementById('log-hours-input');
                const range = document.getElementById('log-hours-range');
                const select = document.getElementById('log-class');

                this._sync(parseFloat(input.value || '0'));

                if (!modal.dataset.bound) {
                    modal.dataset.bound = '1';

                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) this.close();
                    });

                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && modal.classList.contains('active')) this.close();
                    });

                    range.addEventListener('input', () => this._sync(parseFloat(range.value)));
                    input.addEventListener('input', () => {
                        const next = parseFloat(input.value);
                        if (Number.isFinite(next)) this._sync(next);
                    });
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') this.save();
                    });
                }

                // Populate classes each open (keeps in sync with Settings)
                if (select) {
                    const classes = Store.getActiveClasses();
                    select.innerHTML = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                    if (!select.value && classes[0]) select.value = classes[0].id;
                }

                setTimeout(() => input.focus(), 0);
            },
            close() { document.getElementById('modal-log').classList.remove('active'); },
            save() {
                const h = parseFloat(document.getElementById('log-hours-input').value || '0');
                if (!Number.isFinite(h) || h <= 0) {
                    this.close();
                    return;
                }
                const classId = document.getElementById('log-class')?.value;
                Store.addHours(classId, h);
                this.close();
            }
        };

        window.onload = () => {
            Store.init();
            if(!Store.state.setup) {
                Router.render('tmpl-onboarding');
                Onboarding.init();
            } else {
                Router.render('tmpl-dashboard');
                Dashboard.init();
            }
        };
    </script>
</body>
</html>
